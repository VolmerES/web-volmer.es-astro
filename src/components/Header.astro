---
const pathname = Astro.url.pathname;
 
 const navLinks = [
     { href: '/', label: 'INICIO' },
     { href: '/42', label: '42 MADRID' },
     { href: '/aplicaciones', label: 'APLICACIONES' },
     { href: '/portfolio', label: 'PORTAFOLIO' },
     { href: '/servicios', label: 'SERVICIOS' },
     { href: '/blog', label: 'BLOG' },
 ];
 
 const appLink = "https://play.google.com/store/apps/details?id=es.volmer.gallery_swipe_ai&pcampaignid=web_share";
 ---
 
 <header 
     id="main-header"
     data-theme="dark"
     class:list={[
         "fixed top-6 left-1/2 -translate-x-1/2 z-50 transition-all duration-500 backdrop-blur-md border rounded-full shadow-2xl overflow-hidden",
         "w-[90%] md:w-auto max-w-5xl group hover:scale-[1.02]",
         "bg-[#121212]/90 border-white/10"
     ]}
 >
     <!-- Particles Canvas -->
     <canvas id="header-canvas" class="absolute inset-0 w-full h-full pointer-events-none opacity-40 z-0"></canvas>
 
     <div class="relative z-10 h-14 px-4 md:px-6 flex items-center justify-between gap-4 md:gap-8">
         <a href="/" class="text-xl font-bold font-heading tracking-tighter transition-colors shrink-0 hover:text-neon-cyan text-white">
             VOLMER<span class="text-neon-pink">.</span>
         </a>
         
         <nav class="hidden md:flex items-center gap-1 rounded-full p-1 border bg-white/5 border-white/5">
             {navLinks.map(({ href, label }) => {
                 const isActive = href === '/' ? pathname === '/' : (pathname.startsWith(href) && href !== '/#about');
                 return (
                     <a 
                         href={href} 
                         class:list={[
                             "relative text-xs font-bold px-4 py-1.5 rounded-full transition-colors duration-300",
                             isActive ? "text-black" : "text-gray-400 hover:text-white hover:bg-white/10"
                         ]}
                     >
                         {isActive && (
                             <div 
                                 class="absolute inset-0 bg-white rounded-full shadow-lg -z-10"
                                 transition:name="header-active-indicator"
                             ></div>
                         )}
                         <span class="relative z-10">{label}</span>
                     </a>
                 );
             })}
         </nav>
 
         <a href="#" id="contact-btn" class="hidden md:inline-flex items-center justify-center w-10 h-10 rounded-full bg-neon-cyan text-dark-bg hover:bg-white transition-all shadow-[0_0_15px_rgba(5,217,232,0.4)] shrink-0 group">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
        </a>
         
         <!-- Mobile Menu Button -->
        <button id="menu-toggle" class="md:hidden hover:scale-110 transition-transform focus:outline-none text-white hover:text-neon-pink z-50">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
            </svg>
        </button>
    </div>
</header>

<!-- Mobile Menu Overlay -->
<div 
    id="mobile-menu" 
    class="fixed inset-0 z-[60] bg-[#121212]/98 backdrop-blur-xl translate-x-full transition-transform duration-500 ease-in-out md:hidden flex flex-col items-center justify-center text-center"
>
    <!-- Background Particles -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-1/4 left-1/4 w-64 h-64 bg-deep-purple/20 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-1/4 right-1/4 w-64 h-64 bg-neon-pink/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- Close Button -->
    <button id="menu-close" class="absolute top-8 right-8 text-white/70 hover:text-neon-cyan transition-colors z-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
    </button>

    <nav class="relative z-10 flex flex-col gap-8">
        {navLinks.map(({ href, label }) => {
            const isActive = href === '/' ? pathname === '/' : (pathname.startsWith(href) && href !== '/#about');
            return (
                <a 
                    href={href} 
                    class:list={[
                        "text-3xl font-bold tracking-widest transition-all duration-300 font-heading",
                        isActive 
                            ? "text-neon-cyan scale-110 drop-shadow-[0_0_10px_rgba(5,217,232,0.5)]" 
                            : "text-white/60 hover:text-white hover:scale-105"
                    ]}
                >
                    {label}
                </a>
            );
        })}
        
        <div class="h-px w-24 bg-white/10 my-4 mx-auto"></div>
        
        <a href="#contact" class="flex items-center gap-2 text-neon-pink hover:text-white transition-colors uppercase tracking-widest text-sm font-semibold">
            <span>Contactar</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        </a>
    </nav>
</div>

<!-- Contact Modal -->
<dialog id="contact-modal" class="bg-transparent p-0 m-0 backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full h-full max-w-none max-h-none fixed inset-0 z-[100] open:flex items-center justify-center pointer-events-none open:pointer-events-auto transition-all duration-300 opacity-0 open:opacity-100">
    <div class="bg-[#121212] border border-white/10 rounded-2xl w-full max-w-lg mx-4 relative overflow-hidden shadow-2xl scale-95 open:scale-100 transition-all duration-300 p-8 cyberpunk-modal">
        <!-- Close Button -->
        <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <!-- Modal Content -->
        <h2 class="text-3xl font-heading font-bold text-white mb-2">Hablemos<span class="text-neon-cyan">.</span></h2>
        <p class="text-gray-400 mb-8 text-sm">Envíame un correo directo a <span class="text-white font-mono">juanbautista.dev@volmer.es</span></p>

        <form id="contact-form" class="space-y-4">
            <div>
                <label for="subject" class="block text-xs font-bold text-neon-pink uppercase tracking-wider mb-2">ASUNTO</label>
                <input type="text" id="subject" name="subject" required class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-neon-cyan transition-colors" placeholder="Proyecto web, Duda, Saludo...">
            </div>
            
            <div>
                <label for="message" class="block text-xs font-bold text-neon-pink uppercase tracking-wider mb-2">MENSAJE</label>
                <textarea id="message" name="message" rows="5" required class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-neon-cyan transition-colors resize-none" placeholder="Hola Juan, me gustaría hablar sobre..."></textarea>
            </div>

            <button type="submit" class="w-full bg-gradient-to-r from-neon-cyan to-blue-600 text-white font-bold py-3.5 rounded-lg hover:shadow-[0_0_20px_rgba(5,217,232,0.4)] transition-all transform hover:scale-[1.02]">
                ABRIR GESTOR DE CORREO
            </button>
            <p class="text-center text-[10px] text-gray-500 mt-4">
                Esto abrirá tu cliente de correo predeterminado con el mensaje listo para enviar.
            </p>
        </form>
    </div>
</dialog>

<script>
    class HeaderParticles {
        canvas: HTMLCanvasElement | null;
        header: HTMLElement | null;
        ctx: CanvasRenderingContext2D | null;
        particles: any[];
        mouseX: number;
        mouseY: number;
        isLight: boolean;

        constructor() {
            this.canvas = document.getElementById('header-canvas') as HTMLCanvasElement;
            this.header = document.getElementById('main-header');
            this.ctx = null;
            this.particles = [];
            this.mouseX = -1000;
            this.mouseY = -1000;
            this.isLight = false;
            
            if (!this.canvas || !this.header) return;

            this.ctx = this.canvas.getContext('2d');
            this.isLight = this.header.dataset.theme === 'light';
            
            this.init();
        }

        init() {
            this.resize();
            this.createParticles();
            this.addEventListeners();
            this.animate();
        }

        resize() {
            if (!this.canvas || !this.header) return;
            // Set canvas size to match header actual projected size
            const rect = this.header.getBoundingClientRect();
            this.canvas.width = rect.width;
            this.canvas.height = rect.height;
        }

        createParticles() {
            if (!this.canvas) return;
            const particleCount = 40; // Dense enough but performant
            for (let i = 0; i < particleCount; i++) {
                this.particles.push({
                    x: Math.random() * this.canvas.width,
                    y: Math.random() * this.canvas.height,
                    vx: (Math.random() - 0.5) * 0.5,
                    vy: (Math.random() - 0.5) * 0.5,
                    size: Math.random() * 2 + 0.5,
                    color: this.isLight 
                        ? (Math.random() > 0.5 ? '#9333ea' : '#000000') // Purple/Black for light
                        : (Math.random() > 0.5 ? '#05d9e8' : '#ff2a6d')  // Cyan/Pink for dark
                });
            }
        }

        addEventListeners() {
            window.addEventListener('resize', () => {
                this.resize();
                this.particles = [];
                this.createParticles();
            });
            
            // Track mouse relative to the header
            document.addEventListener('mousemove', (e) => {
                if (!this.header) return;
                const rect = this.header.getBoundingClientRect();
                if (
                    e.clientX >= rect.left && 
                    e.clientX <= rect.right && 
                    e.clientY >= rect.top && 
                    e.clientY <= rect.bottom
                ) {
                    this.mouseX = e.clientX - rect.left;
                    this.mouseY = e.clientY - rect.top;
                } else {
                    this.mouseX = -1000;
                    this.mouseY = -1000;
                }
            });
        }

        animate() {
            if (!this.ctx || !this.canvas) return;
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

            this.particles.forEach(p => {
                if (!this.canvas) return;
                // Update position
                p.x += p.vx;
                p.y += p.vy;

                // Bounce off edges
                if (p.x < 0 || p.x > this.canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > this.canvas.height) p.vy *= -1;

                // Mouse interaction (Repulsion)
                const dx = this.mouseX - p.x;
                const dy = this.mouseY - p.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                const maxDist = 80;

                if (distance < maxDist) {
                    const forceDirectionX = dx / distance;
                    const forceDirectionY = dy / distance;
                    const force = (maxDist - distance) / maxDist;
                    
                    // Push away nicely
                    const repulsionStrength = 2; 
                    p.vx -= forceDirectionX * force * repulsionStrength;
                    p.vy -= forceDirectionY * force * repulsionStrength;
                }
                
                // Limit max speed
                const speed = Math.sqrt(p.vx * p.vx + p.vy * p.vy);
                const maxSpeed = 1.5;
                if (speed > maxSpeed) {
                    p.vx = (p.vx / speed) * maxSpeed;
                    p.vy = (p.vy / speed) * maxSpeed;
                }

                if (!this.ctx) return;
                // Draw
                this.ctx.globalAlpha = 0.6;
                this.ctx.fillStyle = p.color;
                this.ctx.beginPath();
                this.ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                this.ctx.fill();
            });

            // Connect nearby circles
            this.particles.forEach((p1, i) => {
                this.particles.slice(i + 1).forEach(p2 => {
                    const dx = p1.x - p2.x;
                    const dy = p1.y - p2.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 50 && this.ctx) {
                        this.ctx.beginPath();
                        this.ctx.strokeStyle = this.isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)';
                        this.ctx.lineWidth = 0.5;
                        this.ctx.moveTo(p1.x, p1.y);
                        this.ctx.lineTo(p2.x, p2.y);
                        this.ctx.stroke();
                    }
                });
            });

            requestAnimationFrame(() => this.animate());
        }
    }

    // Modal Logic
    const initModal = () => {
        const modal = document.getElementById('contact-modal') as HTMLDialogElement;
        const form = document.getElementById('contact-form') as HTMLFormElement;
        const closeBtn = document.getElementById('close-modal');
        
        // Triggers
        const contactBtn = document.getElementById('contact-btn');
        const classTriggers = document.querySelectorAll('.open-contact-modal');

        if (!modal || !form) return;

        const openModal = (e) => {
            e.preventDefault();
            modal.showModal();
            document.body.style.overflow = 'hidden';
        };

        if (contactBtn) {
            contactBtn.addEventListener('click', openModal);
        }

        classTriggers.forEach(btn => {
            btn.addEventListener('click', openModal);
        });

        const closeModal = () => {
            modal.close();
            document.body.style.overflow = '';
        };

        if (closeBtn) {
            closeBtn.addEventListener('click', closeModal);
        }
        
        // Close on click outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        // Handle Form
        form.addEventListener('submit', (e) => {
             e.preventDefault();
             const subject = (document.getElementById('subject') as HTMLInputElement).value;
             const message = (document.getElementById('message') as HTMLTextAreaElement).value;
             
             const mailtoLink = `mailto:juanbautista.dev@volmer.es?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
             
             window.location.href = mailtoLink;
             closeModal();
        });
    };


    // Initialize on load
    document.addEventListener('astro:page-load', () => {
         new HeaderParticles();
         initModal();
    });
    // Fallback for non-SPA
    new HeaderParticles();
    initModal();

    // Mobile Menu Logic
    class MobileMenu {
        menu: HTMLElement | null;
        openBtn: HTMLElement | null;
        closeBtn: HTMLElement | null;
        links: NodeListOf<HTMLAnchorElement>;

        constructor() {
            this.menu = document.getElementById('mobile-menu');
            this.openBtn = document.getElementById('menu-toggle');
            this.closeBtn = document.getElementById('menu-close');
            this.links = document.querySelectorAll('#mobile-menu a');

            if (this.menu && this.openBtn && this.closeBtn) {
                this.init();
            }
        }

        init() {
            this.openBtn?.addEventListener('click', () => this.open());
            this.closeBtn?.addEventListener('click', () => this.close());
            
            // Close on link click
            this.links.forEach(link => {
                link.addEventListener('click', () => this.close());
            });
        }

        open() {
            this.menu?.classList.remove('translate-x-full');
            document.body.style.overflow = 'hidden'; // Prevent scrolling
        }

        close() {
            this.menu?.classList.add('translate-x-full');
            document.body.style.overflow = ''; // Restore scrolling
        }
    }

    // Initialize Menu
    const initMenu = () => {
        new MobileMenu();
    };

    // Run on both initial load and view transitions
    initMenu();
    document.addEventListener('astro:after-swap', initMenu);
</script>
